<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.msa.do_login.myPage.dao.MyPageDAO">
	<!-- 회원 번호로 회원 정보 불러오기 -->
	<select id="getUserVO" parameterType="int" resultType="com.msa.do_login.user.vo.UserVO">
		SELECT * 
		FROM user
		WHERE user_no = #{userNo}
	</select>
	<!-- 회원 번호로 회원 계정 불러오기 -->
	<select id="getLocalAccount" parameterType="int" resultType="com.msa.do_login.user.vo.LocalAccount">
		SELECT * 
		FROM local_account
		WHERE user_no = #{userNo}
	</select>
	<!-- 스타일 코드로 스타일 명칭 불러오기 -->
	<select id="getUserStyle" parameterType="int" resultType="com.msa.do_login.user.vo.UserStyle">
		SELECT * 
		FROM user_style
		WHERE style_code = #{styleCode}
	</select>
	<!-- 능력치 코드로 능력치 명칭 불러오기 -->
	<select id="getUserStat" parameterType="int" resultType="com.msa.do_login.user.vo.UserStat">
		SELECT * 
		FROM user_stat
		WHERE stat_code = #{statCode}
	</select>
	<!-- 회원 번호로 소셜 계정 불러오기 -->
	<select id="getSocialAccount" parameterType="int" resultType="com.msa.do_security.security.vo.SocialAccountVO">
		SELECT * 
		FROM social_account
		WHERE user_no = #{userNo}
	</select>
	
	<update id="update">
	UPDATE user
	SET user_name = #{userName},
		user_birth = #{userBirth},
		user_phone = #{userPhone},
		user_post_code = #{userPostCode},
		user_addr = #{userAddr},
		user_detail_addr = #{userDetailAddr},
		user_gender = #{userGender}
	WHERE user_no = #{userNo}
	</update>
	
	<update id="updateProfile">
	UPDATE user
	SET user_name = #{userName},
		user_comment = #{userComment},
		style_code = #{styleCode},
		stat_code = #{statCode}
	WHERE user_no = #{userNo}
	</update>

	 <insert id="history">
		INSERT INTO user_mod_history (
			user_no, mod_user_name, mod_user_birth, mod_user_phone, mod_user_post_code,
			mod_user_addr, mod_user_detail_addr, mod_ori_pic_name, mod_new_pic_name, mod_date,
			mod_user_exit_status, mod_user_exit_date, mod_user_fail_status, mod_user_fail_cnt,
			mod_auth_code, mod_user_code, mod_user_gender, mod_user_comment, mod_stat_code, mod_style_code
		) 
		VALUES (
			#{userNo}, #{userName}, #{userBirth}, #{userPhone}, #{userPostCode},
			#{userAddr}, #{userDetailAddr}, #{oriPicName}, #{newPicName}, NOW(),
			#{userExitStatus}, #{userExitDate}, #{userFailStatus}, #{userFailCnt},
			#{authCode}, #{userCode}, #{userGender}, #{userComment}, #{styleCode}, #{statCode}
		)
	</insert>
	
	<select id="searchFriendByKeyword" parameterType="String" resultType="com.msa.do_login.user.vo.UserVO">
		SELECT * 
		FROM user
		WHERE user_code = #{keyword}
	</select>
	
	<insert id="insertFriendRequest">
	    INSERT INTO user_relation (
	        from_user_no,
	        to_user_no
	    )
	    VALUES (
	        #{requesterNo},
	        #{requestedNo}
	    )
	</insert>
	
	<select id="getPendingRequests" parameterType="int" resultType="com.msa.do_login.user.vo.UserVO">
		SELECT u.* 
		FROM user_relation r
		JOIN user u ON r.from_user_no = u.user_no
		WHERE to_user_no = #{userNo}
		AND r.relation_status = 'WAIT'
	</select>
	
	<update id="updateRelationStatusToAccept">
		UPDATE user_relation
		SET relation_status = 'ACCEPTED'
		WHERE from_user_no = #{requesterNo}
		AND to_user_no = #{requestedNo}
		AND relation_status = 'WAIT'
	</update>
	
	<update id="deleteRelationRequest">
		UPDATE user_relation
		SET relation_status = 'DECLINED'
		WHERE from_user_no = #{requesterNo}
		AND to_user_no = #{requestedNo}
		AND relation_status = 'WAIT'
	</update>
	
	<select id="getFriendList" parameterType="int" resultType="com.msa.do_login.user.vo.UserVO">
	    SELECT u.*
	    FROM user_relation r
	    JOIN user u
	      ON (
	        (r.from_user_no = #{userNo} AND u.user_no = r.to_user_no)
	        OR
	        (r.to_user_no = #{userNo} AND u.user_no = r.from_user_no)
	      )
	    WHERE r.relation_status = 'ACCEPTED'
	</select>
	
	<select id="getStyleName" parameterType="int" resultType="com.msa.do_login.user.vo.UserStyle">
	    SELECT *
	    FROM user_style
	    WHERE style_code = #{styleCode}
	</select>
	
	<select id="getStatName" parameterType="int" resultType="com.msa.do_login.user.vo.UserStat">
	    SELECT *
	    FROM user_stat
	    WHERE stat_code = #{statCode}
	</select>
	
</mapper>