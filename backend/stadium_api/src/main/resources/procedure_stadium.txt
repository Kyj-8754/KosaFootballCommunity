CREATE DEFINER=`kosa`@`localhost` PROCEDURE `kosa_db`.`sync_stadium_state`()
BEGIN

    INSERT INTO stadium (
        SVCID, SVCNM, PLACENM, X, Y, IMG_PATH, TELNO,
        V_MIN, V_MAX, NOTICE, SUBPLACENM, ORGNM,
        SVCENDTELNO, AREANM, ADRES, DTLCONT, STATE, price
    )
    SELECT 
        sp.SVCID, sp.SVCNM, sp.PLACENM, sp.X, sp.Y, sp.IMG_PATH, sp.TELNO,
        sp.V_MIN, sp.V_MAX, sp.NOTICE, sp.SUBPLACENM, sp.ORGNM,
        sp.SVCENDTELNO, sp.AREANM, sp.ADRES, sp.DTLCONT, 'new', 100000
    FROM stadium_patch sp
    LEFT JOIN stadium s ON sp.SVCID = s.SVCID
    WHERE s.SVCID IS NULL;

    UPDATE stadium s
    LEFT JOIN stadium_patch sp ON s.SVCID = sp.SVCID
    SET s.STATE = 'delete'
    WHERE sp.SVCID IS NULL;

    UPDATE stadium s
    JOIN stadium_patch sp ON s.SVCID = sp.SVCID
    SET s.STATE = 'update'
    WHERE (
        IFNULL(s.SVCNM, '')       != IFNULL(sp.SVCNM, '') OR
        IFNULL(s.PLACENM, '')     != IFNULL(sp.PLACENM, '') OR
        IFNULL(s.X, 0)            != IFNULL(sp.X, 0) OR
        IFNULL(s.Y, 0)            != IFNULL(sp.Y, 0) OR
        IFNULL(s.IMG_PATH, '')    != IFNULL(sp.IMG_PATH, '') OR
        IFNULL(s.TELNO, '')       != IFNULL(sp.TELNO, '') OR
        IFNULL(s.V_MIN, '')       != IFNULL(sp.V_MIN, '') OR
        IFNULL(s.V_MAX, '')       != IFNULL(sp.V_MAX, '') OR
        IFNULL(s.NOTICE, '')      != IFNULL(sp.NOTICE, '') OR
        IFNULL(s.SUBPLACENM, '')  != IFNULL(sp.SUBPLACENM, '') OR
        IFNULL(s.ORGNM, '')       != IFNULL(sp.ORGNM, '') OR
        IFNULL(s.SVCENDTELNO, '') != IFNULL(sp.SVCENDTELNO, '') OR
        IFNULL(s.AREANM, '')      != IFNULL(sp.AREANM, '') OR
        IFNULL(s.ADRES, '')       != IFNULL(sp.ADRES, '') OR
        IFNULL(s.DTLCONT, '')     != IFNULL(sp.DTLCONT, '')
    );
    
    UPDATE stadium s
    JOIN stadium_patch sp ON s.SVCID = sp.SVCID
    SET s.STATE = 'same'
    WHERE s.STATE IS NULL;

    TRUNCATE TABLE stadium_patch;
    
    -- 슬롯 생성 프로시저 호출
CALL generate_reservation_slots();
END